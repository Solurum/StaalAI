Title: Unit Tests

Description:
Please consider all the current code. Write a very extensive unit test battery to avoid regression and find and prevent introducing bugs later on.
Test every code path, if you find a bug. You can extend the current code to fix those. Don't add new features.

Comments:
